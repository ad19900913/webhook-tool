<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置管理 - Webhook工具</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .config-manager {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .config-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .config-tab {
            padding: 10px 20px;
            background: var(--secondary-bg);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .config-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .config-section {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .config-section h3 {
            margin-top: 0;
            color: var(--text-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .config-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .config-item label {
            font-weight: 600;
            color: var(--text-color);
        }

        .config-item input,
        .config-item select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-color);
        }

        .config-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background: var(--secondary-bg);
            color: var(--text-color);
        }

        .btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .config-status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .config-status.valid {
            background: var(--success-bg);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .config-status.invalid {
            background: var(--error-bg);
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }
    </style>
</head>
<body>
    <div class="config-manager">
        <div class="config-header">
            <h1>配置管理</h1>
            <div class="config-actions">
                <button class="btn btn-primary" onclick="reloadConfig()">重新加载</button>
                <button class="btn btn-secondary" onclick="exportConfig('json')">导出JSON</button>
            </div>
        </div>

        <div id="configStatus" class="config-status"></div>

        <div class="config-tabs">
            <button class="config-tab active" onclick="showTab('overview')">概览</button>
            <button class="config-tab" onclick="showTab('server')">服务器</button>
            <button class="config-tab" onclick="showTab('webhook')">Webhook</button>
        </div>

        <!-- 概览标签页 -->
        <div id="overview" class="config-section">
            <h3>配置概览</h3>
            <div class="config-grid">
                <div class="config-item">
                    <label>服务器端口</label>
                    <input type="number" id="server.port" onchange="updateConfig('server.port', this.value)">
                </div>
                <div class="config-item">
                    <label>服务器地址</label>
                    <input type="text" id="server.host" onchange="updateConfig('server.host', this.value)">
                </div>
                <div class="config-item">
                    <label>Webhook最大负载</label>
                    <input type="text" id="webhook.maxPayloadSize" onchange="updateConfig('webhook.maxPayloadSize', this.value)">
                </div>
                <div class="config-item">
                    <label>日志级别</label>
                    <select id="logging.level" onchange="updateConfig('logging.level', this.value)">
                        <option value="error">Error</option>
                        <option value="warn">Warn</option>
                        <option value="info">Info</option>
                        <option value="debug">Debug</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 服务器配置标签页 -->
        <div id="server" class="config-section" style="display: none;">
            <h3>服务器配置</h3>
            <div class="config-grid">
                <div class="config-item">
                    <label>端口</label>
                    <input type="number" id="server.port.server" onchange="updateConfig('server.port', this.value)">
                </div>
                <div class="config-item">
                    <label>主机地址</label>
                    <input type="text" id="server.host.server" onchange="updateConfig('server.host', this.value)">
                </div>
                <div class="config-item">
                    <label>超时时间 (ms)</label>
                    <input type="number" id="server.timeout" onchange="updateConfig('server.timeout', this.value)">
                </div>
            </div>
        </div>

        <!-- Webhook配置标签页 -->
        <div id="webhook" class="config-section" style="display: none;">
            <h3>Webhook配置</h3>
            <div class="config-grid">
                <div class="config-item">
                    <label>最大负载大小</label>
                    <input type="text" id="webhook.maxPayloadSize.webhook" onchange="updateConfig('webhook.maxPayloadSize', this.value)">
                </div>
                <div class="config-item">
                    <label>限流时间窗口 (ms)</label>
                    <input type="number" id="webhook.rateLimit.windowMs" onchange="updateConfig('webhook.rateLimit.windowMs', this.value)">
                </div>
                <div class="config-item">
                    <label>最大请求次数</label>
                    <input type="number" id="webhook.rateLimit.max" onchange="updateConfig('webhook.rateLimit.max', this.value)">
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentConfig = {};
        let currentTab = 'overview';

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadConfiguration();
        });

        // 加载配置
        async function loadConfiguration() {
            try {
                const response = await fetch('/api/config');
                const result = await response.json();
                
                if (result.success) {
                    currentConfig = result.data.config;
                    updateConfigStatus(result.data.isValid);
                    populateConfigFields();
                } else {
                    showError('加载配置失败: ' + result.error);
                }
            } catch (error) {
                showError('加载配置失败: ' + error.message);
            }
        }

        // 更新配置状态
        function updateConfigStatus(isValid) {
            const statusElement = document.getElementById('configStatus');
            if (isValid) {
                statusElement.className = 'config-status valid';
                statusElement.textContent = '✅ 配置有效';
            } else {
                statusElement.className = 'config-status invalid';
                statusElement.textContent = '❌ 配置无效';
            }
        }

        // 填充配置字段
        function populateConfigFields() {
            const fields = [
                'server.port', 'server.host', 'server.timeout',
                'webhook.maxPayloadSize', 'webhook.rateLimit.windowMs', 'webhook.rateLimit.max',
                'logging.level'
            ];

            fields.forEach(field => {
                const value = getConfigValue(field);
                const element = document.getElementById(field);
                if (element && value !== undefined) {
                    element.value = value;
                }
            });
        }

        // 获取配置值
        function getConfigValue(path) {
            const keys = path.split('.');
            let current = currentConfig;
            
            for (const key of keys) {
                if (current && typeof current === 'object' && key in current) {
                    current = current[key];
                } else {
                    return undefined;
                }
            }
            
            return current;
        }

        // 更新配置
        async function updateConfig(path, value) {
            try {
                const response = await fetch(`/api/config/${path}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ value })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    setConfigValue(path, value);
                    showSuccess('配置更新成功');
                } else {
                    showError('配置更新失败: ' + result.error);
                }
            } catch (error) {
                showError('配置更新失败: ' + error.message);
            }
        }

        // 设置配置值
        function setConfigValue(path, value) {
            const keys = path.split('.');
            let current = currentConfig;
            
            for (let i = 0; i < keys.length - 1; i++) {
                const key = keys[i];
                if (!current[key] || typeof current[key] !== 'object') {
                    current[key] = {};
                }
                current = current[key];
            }
            
            current[keys[keys.length - 1]] = value;
        }

        // 重新加载配置
        async function reloadConfig() {
            try {
                const response = await fetch('/api/config/reload', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('配置重新加载成功');
                    loadConfiguration();
                } else {
                    showError('配置重新加载失败: ' + result.error);
                }
            } catch (error) {
                showError('配置重新加载失败: ' + error.message);
            }
        }

        // 导出配置
        function exportConfig(format) {
            window.open(`/api/config/export/${format}`, '_blank');
        }

        // 显示标签页
        function showTab(tabName) {
            const sections = document.querySelectorAll('.config-section');
            sections.forEach(section => {
                section.style.display = 'none';
            });
            
            const tabs = document.querySelectorAll('.config-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).style.display = 'block';
            event.target.classList.add('active');
            currentTab = tabName;
        }

        // 显示成功消息
        function showSuccess(message) {
            console.log('✅ ' + message);
        }

        // 显示错误消息
        function showError(message) {
            console.error('❌ ' + message);
        }
    </script>
</body>
</html>
